<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="admin/layouts/master :: layout(~{::title}, ~{::section})">
<head>
    <title th:text="${title}">User Management</title>
</head>
<body>

<section>
    <div th:if="${success}" class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
        </button>
        <span th:text="${success}"></span>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
        </button>
        <span th:text="${error}"></span>
    </div>
    
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#addUserModal">
        Add User
    </button>
    
    <!-- Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form th:action="@{/admin/users}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="addUserModalLabel">
                            Add New User
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required minlength="2">
                        </div>
                        <div class="form-group">
                            <label for="email">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="phone" name="phone" required minlength="10">
                        </div>
                        <div class="form-group">
                            <label for="password">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                            <span class="help-block">Minimum 6 characters</span>
                        </div>
                        <div class="form-group">
                            <label for="role">Role <span class="text-danger">*</span></label>
                            <select class="form-control" id="role" name="role" required>
                                <option value="">-- Select Role --</option>
                                <option value="USER">User</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="provider">Provider</label>
                            <select class="form-control" id="provider" name="provider">
                                <option value="LOCAL" selected>Local</option>
                                <option value="GOOGLE">Google</option>
                                <option value="FACEBOOK">Facebook</option>
                                <option value="TWITTER">Twitter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="avatar">Avatar URL</label>
                            <input type="text" class="form-control" id="avatar" name="avatar" placeholder="Optional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            Close
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="pull-right nav-tabs__search">
        <form class="form-inline">
            <div class="form-group">
                <span class="input-group">
                    <div class="form-control__with-clear">
                        <input placeholder="Search" name="usersSearch" type="text" id="usersSearch" class="form-control" value="">
                    </div>
                    <span class="input-group-btn">
                        <button type="button" class="custom__search-button btn btn-default">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                    </span>
                </span>
            </div>
        </form>
    </div>
    <div class="clearfix"></div>
    <hr>
    <div class="">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Provider</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Hiển thị khi có dữ liệu -->
                <tr th:each="user : ${users}">
                    <td th:text="${user.id}">1</td>
                    <td th:text="${user.name}"></td>
                    <td th:text="${user.email}">admin@example.com</td>
                    <td th:text="${user.phone}">0123456789</td>
                    <td>
                        <span th:if="${user.role.name() == 'ADMIN'}" class="label label-danger">ADMIN</span>
                        <span th:if="${user.role.name() == 'USER'}" class="label label-primary">USER</span>
                    </td>
                    <td>
                        <span th:switch="${user.provider.name()}">
                            <span th:case="'LOCAL'" class="label label-default">Local</span>
                            <span th:case="'GOOGLE'" class="label label-info">Google</span>
                            <span th:case="'FACEBOOK'" class="label label-primary">Facebook</span>
                            <span th:case="'TWITTER'" class="label label-info">Twitter</span>
                        </span>
                    </td>
                    <td th:text="${#temporals.format(user.created_at, 'dd/MM/yyyy HH:mm')}">01/12/2025</td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-default dropdown-toggle" type="button" 
                                    th:id="'dropdownMenu' + ${user.id}" 
                                    data-toggle="dropdown" 
                                    aria-haspopup="true" 
                                    aria-expanded="true"> 
                                Action <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" th:attr="aria-labelledby='dropdownMenu' + ${user.id}">
                                <li>
                                    <a href="#" 
                                       th:attr="data-user-id=${user.id},
                                                data-user-name=${user.name},
                                                data-user-email=${user.email},
                                                data-user-phone=${user.phone},
                                                data-user-role=${user.role.name()},
                                                data-user-provider=${user.provider.name()},
                                                data-user-avatar=${user.avatar}"
                                       onclick="openEditModal(this); return false;">
                                        Edit
                                    </a>
                                </li>
                                <li>
                                    <a href="#" 
                                       th:attr="data-user-email=${user.email},
                                                data-user-id=${user.id},
                                                data-user-name=${user.name}"
                                       onclick="openPasswordModal(this); return false;">
                                        Set Password
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
    
                <tr th:if="${#lists.isEmpty(users)}">
                    <td colspan="8" class="text-center">
                        <div class="alert alert-warning">
                            <strong>No users found!</strong> Please add some users.
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Modal Edit User -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="editUserForm" th:action="@{/admin/users/update}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="editUserId" name="id">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="editUserModalLabel">
                            Edit User
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="editName">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editName" name="name" required minlength="2">
                        </div>
                        <div class="form-group">
                            <label for="editEmail">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="editPhone">Phone <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editPhone" name="phone" required minlength="10">
                        </div>
                        <div class="form-group">
                            <label for="editRole">Role <span class="text-danger">*</span></label>
                            <select class="form-control" id="editRole" name="role" required>
                                <option value="USER">User</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editProvider">Provider</label>
                            <select class="form-control" id="editProvider" name="provider">
                                <option value="LOCAL">Local</option>
                                <option value="GOOGLE">Google</option>
                                <option value="FACEBOOK">Facebook</option>
                                <option value="TWITTER">Twitter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editAvatar">Avatar URL</label>
                            <input type="text" class="form-control" id="editAvatar" name="avatar" placeholder="Optional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            Close
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Set Password -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="passwordForm" th:action="@{/admin/users/password}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="passwordUserId" name="id">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="passwordModalLabel">
                            Set Password
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="passwordEmail">Email</label>
                            <input type="text" class="form-control" id="passwordEmail" name="email" readonly>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="newPassword" name="password" required minlength="6">
                            <span class="help-block">Minimum 6 characters</span>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            Close
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
    function openEditModal(element) {
        var userId = element.getAttribute('data-user-id');
        var userName = element.getAttribute('data-user-name');
        var userEmail = element.getAttribute('data-user-email');
        var userPhone = element.getAttribute('data-user-phone');
        var userRole = element.getAttribute('data-user-role');
        var userProvider = element.getAttribute('data-user-provider');
        var userAvatar = element.getAttribute('data-user-avatar');

        document.getElementById('editUserId').value = userId;
        document.getElementById('editName').value = userName;
        document.getElementById('editEmail').value = userEmail;
        document.getElementById('editPhone').value = userPhone;
        document.getElementById('editRole').value = userRole;
        document.getElementById('editProvider').value = userProvider;
        document.getElementById('editAvatar').value = userAvatar || '';

        $('#editUserModal').modal('show');
    }

    function openPasswordModal(element) {
        var email = element.getAttribute('data-user-email');
        var userId = element.getAttribute('data-user-id');

        document.getElementById('passwordEmail').value = email;
        document.getElementById('passwordUserId').value = userId;
 
        $('#passwordModal').modal('show');
    }

    // Document ready
    $(document).ready(function() {
        var searchInput = document.getElementById('usersSearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                var input = this.value.toLowerCase();
                var rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(function(row) {
                    var text = row.textContent.toLowerCase();
                    row.style.display = text.includes(input) ? '' : 'none';
                });
            });
        }

        $('#addUserModal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
        });

        $('#editUserModal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
        });

        $('#passwordModal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
        });
    });
    </script>
</section>

</body>
</html>
